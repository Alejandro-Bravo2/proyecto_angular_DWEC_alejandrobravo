<article class="photo-analyzer">
  <section
    class="photo-analyzer__dropzone"
    [class.photo-analyzer__dropzone--active]="isDragging()"
    [class.photo-analyzer__dropzone--has-image]="previewUrl()"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
    (click)="fileInput.click()"
    role="button"
    tabindex="0"
    (keydown.enter)="fileInput.click()"
    (keydown.space)="fileInput.click()"
    [attr.aria-label]="previewUrl() ? 'Cambiar imagen' : 'Subir imagen de comida'"
  >
    @if (previewUrl()) {
      <figure class="photo-analyzer__preview-container">
        <img [src]="previewUrl()" alt="Vista previa de comida" class="photo-analyzer__preview" />
        <figcaption class="photo-analyzer__overlay">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" x2="12" y1="3" y2="15"/>
          </svg>
          <span>Cambiar imagen</span>
        </figcaption>
      </figure>
    } @else {
      <figure class="photo-analyzer__placeholder">
        <svg class="photo-analyzer__icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" x2="12" y1="3" y2="15"/>
        </svg>
        <figcaption class="photo-analyzer__text">
          <strong>Sube una foto de tu comida</strong>
          <span>Arrastra o haz clic para seleccionar</span>
        </figcaption>
      </figure>
    }
    <input
      #fileInput
      type="file"
      accept="image/*"
      class="photo-analyzer__input"
      (change)="onFileSelected($event)"
      aria-hidden="true"
    />
  </section>

  @if (isAnalyzing()) {
    <aside class="photo-analyzer__loading" role="status" aria-live="polite">
      <output class="photo-analyzer__spinner" aria-hidden="true"></output>
      <p>Analizando tu comida con IA...</p>
    </aside>
  }

  @if (analysis()) {
    <section class="photo-analyzer__results">
      <header class="photo-analyzer__results-header">
        <h3>{{ analysis()!.name }}</h3>
        <mark class="photo-analyzer__confidence">{{ analysis()!.confidence }}% seguro</mark>
      </header>

      <ul class="photo-analyzer__macros" role="list">
        <li class="photo-analyzer__macro">
          <data class="photo-analyzer__macro-value" [value]="analysis()!.calories">{{ analysis()!.calories }}</data>
          <span class="photo-analyzer__macro-label">kcal</span>
        </li>
        <li class="photo-analyzer__macro">
          <data class="photo-analyzer__macro-value" [value]="analysis()!.protein">{{ analysis()!.protein }}g</data>
          <span class="photo-analyzer__macro-label">Proteína</span>
        </li>
        <li class="photo-analyzer__macro">
          <data class="photo-analyzer__macro-value" [value]="analysis()!.carbs">{{ analysis()!.carbs }}g</data>
          <span class="photo-analyzer__macro-label">Carbos</span>
        </li>
        <li class="photo-analyzer__macro">
          <data class="photo-analyzer__macro-value" [value]="analysis()!.fat">{{ analysis()!.fat }}g</data>
          <span class="photo-analyzer__macro-label">Grasa</span>
        </li>
      </ul>

      @if (analysis()!.ingredients?.length) {
        <aside class="photo-analyzer__ingredients">
          <h4>Ingredientes detectados</h4>
          <ul>
            @for (ingredient of analysis()!.ingredients; track ingredient) {
              <li>{{ ingredient }}</li>
            }
          </ul>
        </aside>
      }

      <footer class="photo-analyzer__actions">
        <button type="button" class="photo-analyzer__btn photo-analyzer__btn--primary" (click)="confirmAnalysis()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Añadir a mi diario
        </button>
        <button type="button" class="photo-analyzer__btn photo-analyzer__btn--secondary" (click)="reset()">
          Analizar otra
        </button>
      </footer>
    </section>
  }
</article>
