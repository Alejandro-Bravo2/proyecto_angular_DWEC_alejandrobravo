# ============================================================================
# COFIRA - Dependency Updates & Security
# ============================================================================
# Automated dependency updates and security vulnerability scanning
# Runs: Daily at 2 AM UTC
# Features:
#   - Automated dependency updates
#   - Security vulnerability scanning
#   - Auto-PR creation for updates
#   - Dependency graph updates
# ============================================================================

name: ðŸ”„ Dependency Updates

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  # ==========================================================================
  # Frontend Dependencies
  # ==========================================================================
  frontend-deps:
    name: ðŸ“¦ Update Frontend Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ” Check for updates
        working-directory: cofira-app
        run: |
          npm outdated || true
          echo "## ðŸ“¦ Frontend Dependencies Status" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true

      - name: ðŸ”’ Security audit
        working-directory: cofira-app
        run: |
          npm audit --audit-level=moderate || true
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit >> $GITHUB_STEP_SUMMARY || true

      - name: ðŸ”§ Auto-fix vulnerabilities
        working-directory: cofira-app
        run: npm audit fix || true

      - name: ðŸ“ Create PR if changes
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "ðŸ”’ Fix frontend security vulnerabilities"
          title: "ðŸ”’ [Security] Frontend dependency updates"
          body: |
            ## ðŸ”’ Security Updates

            This PR was automatically generated to fix security vulnerabilities.

            ### Changes
            - Updated dependencies with security fixes
            - Run `npm audit` for details

            ### Testing
            - [ ] All tests pass
            - [ ] No breaking changes
          branch: security/frontend-deps
          labels: security, dependencies, automated

  # ==========================================================================
  # Backend Dependencies
  # ==========================================================================
  backend-deps:
    name: â˜• Update Backend Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: ðŸ”§ Make gradlew executable
        working-directory: backend
        run: chmod +x gradlew

      - name: ðŸ” List dependencies
        working-directory: backend
        run: |
          echo "## â˜• Backend Dependencies Status" >> $GITHUB_STEP_SUMMARY
          ./gradlew dependencies --configuration runtimeClasspath > deps.txt || true
          echo "âœ… Dependencies listed successfully" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Dependabot Summary
  # ==========================================================================
  summary:
    name: ðŸ“Š Dependency Update Summary
    runs-on: ubuntu-latest
    needs: [frontend-deps, backend-deps]
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ”„ Dependency Update Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Dependencies: ${{ needs.frontend-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Dependencies: ${{ needs.backend-deps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency scan completed" >> $GITHUB_STEP_SUMMARY
