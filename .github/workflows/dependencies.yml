# ============================================================================
# COFIRA - Dependency Updates & Security
# ============================================================================
# Automated dependency updates and security vulnerability scanning
# Runs: Daily at 2 AM UTC
# Features:
#   - Automated dependency updates
#   - Security vulnerability scanning
#   - Auto-PR creation for updates
#   - Dependency graph updates
# ============================================================================

name: ğŸ”„ Dependency Updates

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  # ==========================================================================
  # Frontend Dependencies
  # ==========================================================================
  frontend-deps:
    name: ğŸ“¦ Update Frontend Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ” Check for updates
        working-directory: cofira-app
        run: |
          npm outdated || true
          echo "## ğŸ“¦ Frontend Dependencies Status" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ”’ Security audit
        working-directory: cofira-app
        run: |
          npm audit --audit-level=moderate || true
          echo "## ğŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ”§ Auto-fix vulnerabilities
        working-directory: cofira-app
        run: npm audit fix || true

      - name: ğŸ“ Create PR if changes
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "ğŸ”’ Fix frontend security vulnerabilities"
          title: "ğŸ”’ [Security] Frontend dependency updates"
          body: |
            ## ğŸ”’ Security Updates

            This PR was automatically generated to fix security vulnerabilities.

            ### Changes
            - Updated dependencies with security fixes
            - Run `npm audit` for details

            ### Testing
            - [ ] All tests pass
            - [ ] No breaking changes
          branch: security/frontend-deps
          labels: security, dependencies, automated

  # ==========================================================================
  # Backend Dependencies
  # ==========================================================================
  backend-deps:
    name: â˜• Update Backend Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ğŸ”§ Make gradlew executable
        working-directory: backend
        run: chmod +x gradlew

      - name: ğŸ” Check for updates
        working-directory: backend
        run: |
          ./gradlew dependencyUpdates || true
          echo "## â˜• Backend Dependencies Status" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”’ OWASP Dependency Check
        working-directory: backend
        run: ./gradlew dependencyCheckAnalyze || true

  # ==========================================================================
  # Dependabot Auto-Merge
  # ==========================================================================
  auto-merge:
    name: ğŸ¤– Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: ğŸ” Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: âœ… Auto-approve
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”€ Auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
