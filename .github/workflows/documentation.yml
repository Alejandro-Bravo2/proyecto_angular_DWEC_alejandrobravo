# ============================================================================
# COFIRA - Documentation Generator
# ============================================================================
# Automatically generates and publishes documentation
# Runs: On push to main
# Features:
#   - Auto-generated API docs
#   - TypeDoc for TypeScript
#   - JavaDoc for Java
#   - Architecture diagrams
#   - GitHub Pages deployment
# ============================================================================

name: ðŸ“š Documentation

on:
  push:
    branches: [main]
    paths:
      - "cofira-app/src/**"
      - "backend/src/**"
      - "docs/**"
      - ".github/workflows/documentation.yml"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==========================================================================
  # Generate Documentation
  # ==========================================================================
  generate:
    name: ðŸ“ Generate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # Frontend Documentation
      - name: ðŸ“¦ Install frontend dependencies
        working-directory: cofira-app
        run: npm ci

      - name: ðŸ“š Generate TypeDoc
        working-directory: cofira-app
        run: |
          npm install --save-dev typedoc
          npx typedoc --out ../docs/frontend src/app || true

      # Backend Documentation
      - name: ðŸ”§ Make gradlew executable
        working-directory: backend
        run: chmod +x gradlew

      - name: ðŸ“š Generate JavaDoc
        working-directory: backend
        run: |
          ./gradlew javadoc || true
          mkdir -p ../docs/backend
          if [ -d build/docs/javadoc ]; then
            cp -r build/docs/javadoc/* ../docs/backend/
          fi

      - name: ðŸ“Š Documentation summary
        run: |
          echo "## ðŸ“š Documentation Generated" >> $GITHUB_STEP_SUMMARY
          if [ -d docs/frontend ]; then
            echo "âœ… Frontend TypeDoc generated" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d docs/backend ]; then
            echo "âœ… Backend JavaDoc generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload documentation
        uses: actions/upload-artifact@v5
        with:
          name: documentation
          path: docs/
          retention-days: 90

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: ðŸ“‹ Documentation Summary
    runs-on: ubuntu-latest
    needs: [generate]
    if: always()
    steps:
      - name: ðŸ“Š Create summary
        run: |
          echo "# ðŸ“š Documentation Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation Generation: ${{ needs.generate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation workflow completed" >> $GITHUB_STEP_SUMMARY
