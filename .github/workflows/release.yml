# ============================================================================
# COFIRA - Release Management
# ============================================================================
# Automated release process with semantic versioning
# Runs: On push to main with version tags
# Features:
#   - Semantic versioning
#   - Automated changelog
#   - GitHub release creation
#   - Docker image tagging
#   - Release notes generation
# ============================================================================

name: ðŸš€ Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # ==========================================================================
  # Create Release
  # ==========================================================================
  release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "## ðŸ“¦ Release v$VERSION" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          cat > RELEASE_NOTES.md << 'EOF'
          # ðŸš€ Release v${{ steps.version.outputs.version }}

          ## ðŸ“‹ What's Changed

          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (@%an)" >> RELEASE_NOTES.md
          else
            git log --pretty=format:"- %s (@%an)" >> RELEASE_NOTES.md
          fi

          cat >> RELEASE_NOTES.md << 'EOF'

          ## ðŸ³ Docker Images

          ### Frontend
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}/cofira-frontend:v${{ steps.version.outputs.version }}
          \`\`\`

          ### Backend
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}/cofira-backend:v${{ steps.version.outputs.version }}
          \`\`\`

          ## ðŸ“š Documentation

          - [Installation Guide](./INSTALLATION.md)
          - [API Documentation](./API-DOCS.md)
          - [User Guide](./USER_GUIDE.md)

          ## ðŸ™ Contributors

          Thank you to all contributors who made this release possible!
          EOF

          cat RELEASE_NOTES.md >> $GITHUB_STEP_SUMMARY

      - name: ðŸ·ï¸ Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          bodyFile: RELEASE_NOTES.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          generateReleaseNotes: true

  # ==========================================================================
  # Build Release Artifacts
  # ==========================================================================
  build-artifacts:
    name: ðŸ—ï¸ Build Release Artifacts
    runs-on: ubuntu-latest
    needs: release
    strategy:
      matrix:
        include:
          - component: frontend
            path: cofira-app
          - component: backend
            path: backend
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Build ${{ matrix.component }}
        run: |
          echo "Building ${{ matrix.component }}..."

      - name: ðŸ“¦ Create archive
        run: |
          tar -czf ${{ matrix.component }}-v${{ needs.release.outputs.version }}.tar.gz ${{ matrix.path }}

      - name: ðŸ“¤ Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ matrix.component }}-v${{ needs.release.outputs.version }}.tar.gz
          tag: v${{ needs.release.outputs.version }}
          overwrite: true

  # ==========================================================================
  # Tag Docker Images
  # ==========================================================================
  tag-docker:
    name: ðŸ·ï¸ Tag Docker Images
    runs-on: ubuntu-latest
    needs: release
    strategy:
      matrix:
        component: [frontend, backend]
    steps:
      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Tag and push
        run: |
          LATEST_IMAGE=ghcr.io/${{ github.repository }}/cofira-${{ matrix.component }}:latest
          VERSION_IMAGE=ghcr.io/${{ github.repository }}/cofira-${{ matrix.component }}:v${{ needs.release.outputs.version }}

          docker pull $LATEST_IMAGE
          docker tag $LATEST_IMAGE $VERSION_IMAGE
          docker push $VERSION_IMAGE

          echo "âœ… Tagged ${{ matrix.component }} with version v${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Update Documentation
  # ==========================================================================
  update-docs:
    name: ðŸ“š Update Documentation
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Update version in README
        run: |
          sed -i 's/Version: [0-9]\+\.[0-9]\+\.[0-9]\+/Version: ${{ needs.release.outputs.version }}/' README.md || true

      - name: ðŸ“ Update CHANGELOG
        run: |
          cat > TEMP_CHANGELOG.md << EOF
          # Changelog

          ## [v${{ needs.release.outputs.version }}] - $(date +%Y-%m-%d)

          ${{ needs.release.outputs.changelog }}

          EOF

          if [ -f CHANGELOG.md ]; then
            tail -n +2 CHANGELOG.md >> TEMP_CHANGELOG.md
          fi

          mv TEMP_CHANGELOG.md CHANGELOG.md

      - name: ðŸ’¾ Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md CHANGELOG.md
          git commit -m "ðŸ“ Update documentation for v${{ needs.release.outputs.version }}" || true
          git push || true

  # ==========================================================================
  # Notify
  # ==========================================================================
  notify:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [release, build-artifacts, tag-docker]
    steps:
      - name: ðŸŽ‰ Success message
        run: |
          echo "# ðŸŽ‰ Release v${{ needs.release.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Completed Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images tagged" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
